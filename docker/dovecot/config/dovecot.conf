# Dovecot configuration for KoeMail

# Protocols to serve
protocols = imap pop3 lmtp sieve

# Listen on all interfaces
listen = *, ::

# Logging
log_path = /dev/stdout
info_log_path = /dev/stdout
debug_log_path = /dev/stdout

# SSL/TLS Configuration
ssl = required
ssl_cert = </etc/ssl/certs/mail/fullchain.pem
ssl_key = </etc/ssl/certs/mail/privkey.pem
ssl_min_protocol = TLSv1.2
ssl_cipher_list = ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
ssl_prefer_server_ciphers = yes

# Authentication configuration
auth_mechanisms = plain login
auth_username_format = %Ln
disable_plaintext_auth = yes

# Include auth configuration
!include auth-sql.conf.ext

# Mail location and mailbox format
mail_location = maildir:/var/mail/%d/%n
mail_uid = 1000
mail_gid = 1000
first_valid_uid = 1000
last_valid_uid = 1000

# Mailbox configuration
namespace inbox {
  type = private
  separator = /
  prefix =
  location =
  inbox = yes
  hidden = no
  list = yes
  subscriptions = yes

  mailbox Drafts {
    special_use = \Drafts
    auto_subscribe = yes
  }
  mailbox Junk {
    special_use = \Junk
    auto_create = yes
    auto_subscribe = yes
  }
  mailbox Spam {
    special_use = \Junk
    auto_create = yes
    auto_subscribe = yes
  }
  mailbox Sent {
    special_use = \Sent
    auto_subscribe = yes
  }
  mailbox "Sent Messages" {
    special_use = \Sent
  }
  mailbox Trash {
    special_use = \Trash
    auto_create = yes
    auto_subscribe = yes
  }
}

# IMAP configuration
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }

  process_min_avail = 0
  process_limit = 1000
}

service imap {
  process_limit = 1024
}

# POP3 configuration
service pop3-login {
  inet_listener pop3 {
    port = 110
  }
  inet_listener pop3s {
    port = 995
    ssl = yes
  }
}

service pop3 {
  process_limit = 1024
}

# LMTP service for local delivery
service lmtp {
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
    group = postfix
    mode = 0600
    user = postfix
  }
}

# Sieve configuration
service managesieve-login {
  inet_listener sieve {
    port = 4190
  }
}

service managesieve {
}

# Authentication service for SASL
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0666
    user = postfix
    group = postfix
  }

  unix_listener auth-userdb {
    mode = 0600
    user = vmail
    group = vmail
  }

  user = dovecot
}

service auth-worker {
  user = vmail
}

# Statistics
service stats {
  unix_listener stats-reader {
    user = vmail
    group = vmail
    mode = 0660
  }

  unix_listener stats-writer {
    user = vmail
    group = vmail
    mode = 0660
  }
}

# Quota configuration
plugin {
  quota = maildir:User quota
  quota_grace = 10%%
  quota_status_success = DUNNO
  quota_status_nouser = DUNNO
  quota_status_overquota = "552 5.2.2 Mailbox is full"

  # Sieve plugin configuration
  sieve = file:~/sieve;active=~/.dovecot.sieve
  sieve_global_extensions = +vnd.dovecot.pipe +vnd.dovecot.environment
}

# Protocol-specific settings
protocol imap {
  mail_plugins = quota imap_quota
  imap_metadata = yes
}

protocol pop3 {
  mail_plugins = quota
  pop3_uidl_format = %08Xu%08Xv
  pop3_client_workarounds = outlook-no-nuls oe-ns-eoh
}

protocol lmtp {
  mail_plugins = quota sieve
}

protocol sieve {
  managesieve_max_line_length = 65536
}